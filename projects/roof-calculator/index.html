<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roof Measurement Tool</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: #0f0f0c; color: #e8e4d4; height: 100vh; display: flex; flex-direction: column; }
  #header {
    background: linear-gradient(135deg, #1a1a14, #1c1c17);
    border-bottom: 2px solid #c4a24e;
    padding: 12px 20px;
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;
    z-index: 1000;
  }
  #header h1 { font-size: 17px; font-weight: 700; letter-spacing: -0.02em; }
  #header .subtitle { font-size: 12px; color: #8a8a7a; margin-top: 2px; }
  .header-controls { display: flex; gap: 8px; align-items: center; }
  .header-controls button {
    padding: 6px 14px; border: 1px solid #2e2e24; border-radius: 5px;
    background: #1a1a16; color: #8a8a7a; font-size: 12px; cursor: pointer;
    font-family: 'JetBrains Mono', monospace; transition: all 0.15s;
  }
  .header-controls button:hover { border-color: #c4a24e; color: #c4a24e; }
  .header-controls button.active { background: #c4a24e; color: #0f0f0c; border-color: #c4a24e; }
  #main { display: flex; flex: 1; min-height: 0; }
  #map { flex: 1; min-width: 0; }
  #sidebar {
    width: 340px; background: #1c1c17; border-left: 1px solid #2e2e24;
    overflow-y: auto; display: flex; flex-direction: column;
  }
  .sidebar-header {
    padding: 14px 16px; border-bottom: 1px solid #2e2e24;
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em;
    color: #c4a24e; font-family: 'JetBrains Mono', monospace; font-weight: 600;
  }
  .instructions {
    padding: 12px 16px; background: rgba(196,162,78,0.06);
    border-bottom: 1px solid #2e2e24; font-size: 12px; color: #8a8a7a; line-height: 1.6;
  }
  .instructions strong { color: #c4a24e; }
  .instructions ol { padding-left: 18px; margin-top: 6px; }
  .instructions li { margin-bottom: 4px; }
  .section-list { flex: 1; overflow-y: auto; padding: 8px 0; }
  .section-card {
    margin: 6px 12px; padding: 12px 14px;
    background: #1a1a16; border: 1px solid #2e2e24; border-radius: 8px;
    transition: border-color 0.15s;
  }
  .section-card:hover { border-color: #3a3a2e; }
  .section-card .top-row {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
  }
  .section-card .section-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 24px; height: 24px; border-radius: 50%;
    font-size: 12px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
  }
  .section-card .name-input {
    flex: 1; margin-left: 8px; background: transparent; border: none;
    color: #e8e4d4; font-size: 13px; font-weight: 600; outline: none;
    font-family: 'Inter', sans-serif;
  }
  .section-card .name-input::placeholder { color: #5a5a4a; }
  .section-card .remove-btn {
    background: none; border: none; color: #6a3a3a; cursor: pointer;
    font-size: 16px; padding: 0 4px; transition: color 0.15s;
  }
  .section-card .remove-btn:hover { color: #a04040; }
  .section-card .metrics {
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;
  }
  .metric-box {
    background: #141410; border-radius: 4px; padding: 6px 8px;
  }
  .metric-box .label {
    font-size: 9px; text-transform: uppercase; letter-spacing: 0.08em;
    color: #6a6a5a; font-family: 'JetBrains Mono', monospace;
  }
  .metric-box .value {
    font-size: 15px; font-weight: 600; font-family: 'JetBrains Mono', monospace;
    margin-top: 2px;
  }
  .metric-box .unit { font-size: 10px; color: #6a6a5a; }
  .pitch-row { display: flex; align-items: center; gap: 8px; }
  .pitch-row label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
    color: #6a6a5a; font-family: 'JetBrains Mono', monospace; white-space: nowrap;
  }
  .pitch-row select {
    flex: 1; background: #141410; border: 1px solid #2e2e24; border-radius: 4px;
    color: #e8e4d4; padding: 5px 8px; font-size: 12px; cursor: pointer;
    font-family: 'JetBrains Mono', monospace;
  }
  .summary-panel {
    border-top: 2px solid #c4a24e; padding: 14px 16px;
    background: linear-gradient(135deg, #1e1e16, #1c1c17);
  }
  .summary-panel h3 {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em;
    color: #c4a24e; font-family: 'JetBrains Mono', monospace;
    margin-bottom: 10px; font-weight: 600;
  }
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .summary-box {
    background: #1a1a16; border-radius: 6px; padding: 10px 12px;
    border: 1px solid #2e2e24;
  }
  .summary-box.highlight { border-color: rgba(196,162,78,0.5); }
  .summary-box .label {
    font-size: 9px; text-transform: uppercase; letter-spacing: 0.08em;
    color: #6a6a5a; font-family: 'JetBrains Mono', monospace;
  }
  .summary-box .value {
    font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
    margin-top: 3px;
  }
  .summary-box .unit { font-size: 10px; color: #6a6a5a; }
  .waste-row {
    display: flex; align-items: center; gap: 8px; margin-top: 10px;
  }
  .waste-row label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
    color: #6a6a5a; font-family: 'JetBrains Mono', monospace;
  }
  .waste-row input {
    width: 50px; background: #141410; border: 1px solid #2e2e24; border-radius: 4px;
    color: #e8e4d4; padding: 4px 8px; font-size: 13px; text-align: center;
    font-family: 'JetBrains Mono', monospace;
  }
  .empty-state {
    padding: 30px 20px; text-align: center; color: #5a5a4a; font-size: 13px; line-height: 1.6;
  }
  .empty-state svg { margin-bottom: 12px; opacity: 0.4; }

  /* Address bar */
  .address-bar {
    display: flex; align-items: center; gap: 8px; padding: 8px 16px;
    border-bottom: 1px solid #2e2e24; background: rgba(196,162,78,0.04);
  }
  .address-bar label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
    color: #6a6a5a; font-family: 'JetBrains Mono', monospace; white-space: nowrap;
  }
  .address-bar input {
    flex: 1; background: #141410; border: 1px solid #2e2e24; border-radius: 4px;
    color: #e8e4d4; padding: 6px 10px; font-size: 13px;
    font-family: 'Inter', sans-serif;
  }
  .address-bar button {
    padding: 6px 12px; border: 1px solid #c4a24e; border-radius: 4px;
    background: rgba(196,162,78,0.15); color: #c4a24e; font-size: 12px;
    cursor: pointer; font-family: 'JetBrains Mono', monospace; white-space: nowrap;
  }
  .address-bar button:hover { background: #c4a24e; color: #0f0f0c; }

  /* Leaflet overrides */
  .leaflet-draw-toolbar a { background-color: #1c1c17 !important; border-color: #2e2e24 !important; }
  .leaflet-draw-toolbar a:hover { background-color: #2e2e24 !important; }
  .leaflet-bar a { color: #e8e4d4 !important; background-color: #1c1c17 !important; border-color: #2e2e24 !important; }
  .leaflet-bar a:hover { background-color: #2e2e24 !important; }
  @media (max-width: 768px) {
    #main { flex-direction: column; }
    #sidebar { width: 100%; max-height: 45vh; }
    #map { min-height: 55vh; }
  }
</style>
</head>
<body>
<div id="header">
  <div>
    <h1>Roof Measurement Tool</h1>
    <div class="subtitle" id="header-subtitle">Search for an address or navigate the map to get started</div>
  </div>
  <div class="header-controls">
    <button data-layer="google" class="active" onclick="setTileLayer('google')">Google Sat</button>
    <button data-layer="googleHybrid" onclick="setTileLayer('googleHybrid')">Hybrid</button>
    <button data-layer="esri" onclick="setTileLayer('esri')">ESRI Sat</button>
    <button data-layer="street" onclick="setTileLayer('street')">Street</button>
    <button id="btn-export" onclick="exportData()">Export CSV</button>
  </div>
</div>
<div id="main">
  <div id="map"></div>
  <div id="sidebar">
    <div class="sidebar-header">Roof Sections</div>
    <div class="address-bar">
      <label>Address</label>
      <input type="text" id="address-input" placeholder="Enter an address to search..." onkeydown="if(event.key==='Enter')geocodeAddress()">
      <button onclick="geocodeAddress()">Go</button>
    </div>
    <div class="instructions">
      <strong>How to measure:</strong>
      <ol>
        <li>Search for an <strong>address</strong> above or navigate the map</li>
        <li>Click the <strong>polygon tool</strong> on the map toolbar</li>
        <li>Click each corner of a roof section</li>
        <li>Click the first point again to close</li>
        <li>Set the <strong>pitch</strong> for each section</li>
        <li>Repeat for each roof section</li>
      </ol>
    </div>
    <div class="section-list" id="section-list">
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 48 48"><polygon points="24,4 4,28 44,28" fill="none" stroke="#8a8a7a" stroke-width="2"/><line x1="14" y1="28" x2="14" y2="44" stroke="#8a8a7a" stroke-width="1.5"/><line x1="34" y1="28" x2="34" y2="44" stroke="#8a8a7a" stroke-width="1.5"/><line x1="14" y1="44" x2="34" y2="44" stroke="#8a8a7a" stroke-width="1.5"/></svg>
        <div>Draw polygons on the map to measure roof sections</div>
      </div>
    </div>
    <div class="summary-panel" id="summary" style="display:none;">
      <h3>Summary</h3>
      <div class="summary-grid">
        <div class="summary-box">
          <div class="label">Plan Area</div>
          <div class="value" id="total-plan">0.0 <span class="unit">m²</span></div>
        </div>
        <div class="summary-box highlight">
          <div class="label">True Area</div>
          <div class="value" style="color:#c4a24e" id="total-true">0.0 <span class="unit">m²</span></div>
        </div>
        <div class="summary-box">
          <div class="label">Perimeter</div>
          <div class="value" id="total-perim">0.0 <span class="unit">m</span></div>
        </div>
        <div class="summary-box highlight">
          <div class="label">With Waste</div>
          <div class="value" style="color:#d4a04e" id="total-waste">0.0 <span class="unit">m²</span></div>
        </div>
      </div>
      <div class="waste-row">
        <label>Waste %</label>
        <input type="number" id="waste-pct" value="20" min="0" max="100" onchange="updateSummary()">
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
const PITCH_MULTIPLIERS = {
  "0:12": { label: "Flat (0\u00b0)", mult: 1.0 },
  "2:12": { label: "2:12 (9.5\u00b0)", mult: 1.014 },
  "3:12": { label: "3:12 (14\u00b0)", mult: 1.031 },
  "4:12": { label: "4:12 (18\u00b0)", mult: 1.054 },
  "5:12": { label: "5:12 (23\u00b0)", mult: 1.083 },
  "6:12": { label: "6:12 (27\u00b0)", mult: 1.118 },
  "7:12": { label: "7:12 (30\u00b0)", mult: 1.158 },
  "8:12": { label: "8:12 (34\u00b0) \u2190 typical UK", mult: 1.202 },
  "9:12": { label: "9:12 (37\u00b0) \u2190 steep UK", mult: 1.25 },
  "10:12": { label: "10:12 (40\u00b0)", mult: 1.302 },
  "11:12": { label: "11:12 (43\u00b0)", mult: 1.357 },
  "12:12": { label: "12:12 (45\u00b0)", mult: 1.414 },
};
const COLORS = ["#c4a24e","#4e9ac4","#c44e6a","#4ec47a","#9a4ec4","#c48a4e","#4ec4c4","#c44ea2"];

// Default view — zoomed out to UK
const DEFAULT_LAT = 52.5;
const DEFAULT_LNG = -1.5;
const DEFAULT_ZOOM = 6;

// Map setup
const map = L.map('map', { zoomControl: true }).setView([DEFAULT_LAT, DEFAULT_LNG], DEFAULT_ZOOM);

const tileLayers = {
  google: L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    attribution: 'Imagery &copy; Google', maxZoom: 21, maxNativeZoom: 20
  }),
  googleHybrid: L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    attribution: 'Imagery &copy; Google', maxZoom: 21, maxNativeZoom: 20
  }),
  esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri', maxZoom: 21, maxNativeZoom: 19
  }),
  street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap', maxZoom: 21, maxNativeZoom: 19
  })
};
let activeLayerKey = 'google';
tileLayers.google.addTo(map);

function setTileLayer(type) {
  map.removeLayer(tileLayers[activeLayerKey]);
  tileLayers[type].addTo(map);
  activeLayerKey = type;
  document.querySelectorAll('.header-controls button[data-layer]').forEach(b => {
    b.classList.toggle('active', b.dataset.layer === type);
  });
}

// Geocoding via Nominatim (OpenStreetMap)
let targetMarker = null;
function geocodeAddress() {
  const input = document.getElementById('address-input');
  const address = input.value.trim();
  if (!address) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
    .then(r => r.json())
    .then(results => {
      if (results.length === 0) {
        alert('Address not found. Try a different search.');
        return;
      }
      const lat = parseFloat(results[0].lat);
      const lng = parseFloat(results[0].lon);
      const displayName = results[0].display_name;
      map.setView([lat, lng], 19);
      if (targetMarker) map.removeLayer(targetMarker);
      targetMarker = L.circleMarker([lat, lng], {
        radius: 6, color: '#c4a24e', fillColor: '#c4a24e', fillOpacity: 0.4, weight: 2
      }).addTo(map).bindPopup(`<b>${displayName}</b>`).openPopup();
      document.getElementById('header-subtitle').textContent = displayName.split(',').slice(0, 3).join(',');
    })
    .catch(() => alert('Geocoding failed. Check your connection and try again.'));
}

// Drawing
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
const drawControl = new L.Control.Draw({
  position: 'topleft',
  draw: {
    polygon: {
      allowIntersection: false,
      showArea: true,
      shapeOptions: { color: COLORS[0], weight: 2, fillOpacity: 0.2 }
    },
    polyline: {
      shapeOptions: { color: '#c4a24e', weight: 2 }
    },
    rectangle: {
      shapeOptions: { color: COLORS[0], weight: 2, fillOpacity: 0.2 }
    },
    circle: false,
    circlemarker: false,
    marker: false
  },
  edit: { featureGroup: drawnItems, remove: true }
});
map.addControl(drawControl);

// Section data
let sections = [];
let sectionCounter = 0;

function geodesicArea(latlngs) {
  const R = 6371000;
  let total = 0;
  const pts = latlngs.map(ll => [ll.lat * Math.PI / 180, ll.lng * Math.PI / 180]);
  for (let i = 0; i < pts.length; i++) {
    const j = (i + 1) % pts.length;
    total += (pts[j][1] - pts[i][1]) * (2 + Math.sin(pts[i][0]) + Math.sin(pts[j][0]));
  }
  return Math.abs(total * R * R / 2);
}

function geodesicPerimeter(latlngs) {
  let total = 0;
  for (let i = 0; i < latlngs.length; i++) {
    const j = (i + 1) % latlngs.length;
    total += latlngs[i].distanceTo(latlngs[j]);
  }
  return total;
}

function getEdgeLengths(latlngs) {
  const edges = [];
  for (let i = 0; i < latlngs.length; i++) {
    const j = (i + 1) % latlngs.length;
    edges.push(latlngs[i].distanceTo(latlngs[j]));
  }
  return edges;
}

map.on(L.Draw.Event.CREATED, function (e) {
  const layer = e.layer;
  const type = e.layerType;

  if (type === 'polyline') {
    const latlngs = layer.getLatLngs();
    let totalDist = 0;
    for (let i = 1; i < latlngs.length; i++) {
      totalDist += latlngs[i - 1].distanceTo(latlngs[i]);
    }
    layer.bindPopup(`<b>Distance:</b> ${totalDist.toFixed(2)} m`).openPopup();
    drawnItems.addLayer(layer);
    return;
  }

  sectionCounter++;
  const color = COLORS[(sectionCounter - 1) % COLORS.length];
  layer.setStyle({ color: color, fillColor: color, weight: 2, fillOpacity: 0.25 });

  const latlngs = layer.getLatLngs()[0];
  const area = geodesicArea(latlngs);
  const perimeter = geodesicPerimeter(latlngs);
  const edges = getEdgeLengths(latlngs);

  const section = {
    id: sectionCounter,
    name: '',
    layer: layer,
    latlngs: latlngs,
    planArea: area,
    perimeter: perimeter,
    edges: edges,
    pitch: '8:12',
    color: color
  };
  sections.push(section);
  drawnItems.addLayer(layer);
  updatePolygonPopup(section);
  renderSections();
  updateSummary();
});

map.on(L.Draw.Event.DELETED, function (e) {
  e.layers.eachLayer(function (layer) {
    sections = sections.filter(s => s.layer !== layer);
  });
  renderSections();
  updateSummary();
});

map.on(L.Draw.Event.EDITED, function (e) {
  e.layers.eachLayer(function (layer) {
    const section = sections.find(s => s.layer === layer);
    if (section) {
      const latlngs = layer.getLatLngs()[0];
      section.latlngs = latlngs;
      section.planArea = geodesicArea(latlngs);
      section.perimeter = geodesicPerimeter(latlngs);
      section.edges = getEdgeLengths(latlngs);
      updatePolygonPopup(section);
    }
  });
  renderSections();
  updateSummary();
});

function updatePolygonPopup(section) {
  const mult = PITCH_MULTIPLIERS[section.pitch].mult;
  const trueArea = section.planArea * mult;
  const edgeStr = section.edges.map((e, i) => `Edge ${i + 1}: ${e.toFixed(2)}m`).join('<br>');
  section.layer.bindPopup(
    `<b>${section.name || 'Section ' + section.id}</b><br>` +
    `Plan: ${section.planArea.toFixed(1)} m\u00b2<br>` +
    `True: ${trueArea.toFixed(1)} m\u00b2 (\u00d7${mult})<br>` +
    `Perimeter: ${section.perimeter.toFixed(1)} m<br>` +
    `<hr style="margin:4px 0;border-color:#333">${edgeStr}`
  );
}

function renderSections() {
  const list = document.getElementById('section-list');
  const summary = document.getElementById('summary');

  if (sections.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 48 48"><polygon points="24,4 4,28 44,28" fill="none" stroke="#8a8a7a" stroke-width="2"/><line x1="14" y1="28" x2="14" y2="44" stroke="#8a8a7a" stroke-width="1.5"/><line x1="34" y1="28" x2="34" y2="44" stroke="#8a8a7a" stroke-width="1.5"/><line x1="14" y1="44" x2="34" y2="44" stroke="#8a8a7a" stroke-width="1.5"/></svg>
      <div>Draw polygons on the map to measure roof sections</div>
    </div>`;
    summary.style.display = 'none';
    return;
  }

  summary.style.display = 'block';
  let html = '';

  sections.forEach((s, idx) => {
    const mult = PITCH_MULTIPLIERS[s.pitch].mult;
    const trueArea = s.planArea * mult;
    const edgesHtml = s.edges.map((e, i) =>
      `<span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:#8a8a7a;">E${i+1}: ${e.toFixed(2)}m</span>`
    ).join(' &nbsp;');

    let pitchOptions = '';
    for (const [key, val] of Object.entries(PITCH_MULTIPLIERS)) {
      pitchOptions += `<option value="${key}" ${s.pitch === key ? 'selected' : ''}>${val.label} \u2014 \u00d7${val.mult}</option>`;
    }

    html += `
    <div class="section-card" id="card-${s.id}">
      <div class="top-row">
        <span class="section-num" style="background:${s.color};color:#0f0f0c;">${idx + 1}</span>
        <input class="name-input" type="text" placeholder="Section ${s.id}" value="${s.name}"
               onchange="updateName(${s.id}, this.value)">
        <button class="remove-btn" onclick="removeSection(${s.id})" title="Remove">\u2715</button>
      </div>
      <div class="metrics">
        <div class="metric-box">
          <div class="label">Plan Area</div>
          <div class="value">${s.planArea.toFixed(1)} <span class="unit">m\u00b2</span></div>
        </div>
        <div class="metric-box">
          <div class="label">True Area</div>
          <div class="value" style="color:${s.color}">${trueArea.toFixed(1)} <span class="unit">m\u00b2</span></div>
        </div>
        <div class="metric-box">
          <div class="label">Perimeter</div>
          <div class="value">${s.perimeter.toFixed(1)} <span class="unit">m</span></div>
        </div>
        <div class="metric-box">
          <div class="label">Edges</div>
          <div class="value" style="font-size:11px;line-height:1.4">${s.edges.length} sides</div>
        </div>
      </div>
      <div style="margin-bottom:6px;">${edgesHtml}</div>
      <div class="pitch-row">
        <label>Pitch</label>
        <select onchange="updatePitch(${s.id}, this.value)">${pitchOptions}</select>
      </div>
    </div>`;
  });

  list.innerHTML = html;
}

function updateName(id, name) {
  const s = sections.find(s => s.id === id);
  if (s) { s.name = name; updatePolygonPopup(s); }
}

function updatePitch(id, pitch) {
  const s = sections.find(s => s.id === id);
  if (s) { s.pitch = pitch; updatePolygonPopup(s); renderSections(); updateSummary(); }
}

function removeSection(id) {
  const s = sections.find(s => s.id === id);
  if (s) {
    drawnItems.removeLayer(s.layer);
    sections = sections.filter(s => s.id !== id);
    renderSections();
    updateSummary();
  }
}

function updateSummary() {
  if (sections.length === 0) return;
  const wastePct = parseInt(document.getElementById('waste-pct').value) || 0;
  let totalPlan = 0, totalTrue = 0, totalPerim = 0;
  sections.forEach(s => {
    const mult = PITCH_MULTIPLIERS[s.pitch].mult;
    totalPlan += s.planArea;
    totalTrue += s.planArea * mult;
    totalPerim += s.perimeter;
  });
  const totalWaste = totalTrue * (1 + wastePct / 100);
  document.getElementById('total-plan').innerHTML = `${totalPlan.toFixed(1)} <span class="unit">m\u00b2</span>`;
  document.getElementById('total-true').innerHTML = `${totalTrue.toFixed(1)} <span class="unit">m\u00b2</span>`;
  document.getElementById('total-perim').innerHTML = `${totalPerim.toFixed(1)} <span class="unit">m</span>`;
  document.getElementById('total-waste').innerHTML = `${totalWaste.toFixed(1)} <span class="unit">m\u00b2</span>`;
}

function exportData() {
  if (sections.length === 0) { alert('No sections to export.'); return; }
  const wastePct = parseInt(document.getElementById('waste-pct').value) || 0;
  let csv = 'Section,Name,Plan Area (m\u00b2),Pitch,Multiplier,True Area (m\u00b2),Perimeter (m),Edge Lengths (m)\n';
  sections.forEach((s, i) => {
    const mult = PITCH_MULTIPLIERS[s.pitch].mult;
    const trueArea = s.planArea * mult;
    const edges = s.edges.map(e => e.toFixed(2)).join('; ');
    csv += `${i+1},"${s.name || 'Section ' + s.id}",${s.planArea.toFixed(2)},${s.pitch},${mult},${trueArea.toFixed(2)},${s.perimeter.toFixed(2)},"${edges}"\n`;
  });
  let totalPlan = 0, totalTrue = 0, totalPerim = 0;
  sections.forEach(s => { totalPlan += s.planArea; totalTrue += s.planArea * PITCH_MULTIPLIERS[s.pitch].mult; totalPerim += s.perimeter; });
  csv += `\nTOTALS,,${totalPlan.toFixed(2)},,,"${totalTrue.toFixed(2)}",${totalPerim.toFixed(2)},\n`;
  csv += `With ${wastePct}% waste,,,,,"${(totalTrue * (1 + wastePct/100)).toFixed(2)}",,\n`;
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'roof-measurements.csv'; a.click();
  URL.revokeObjectURL(url);
}

// Add scale control
L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);
</script>
</body>
</html>
